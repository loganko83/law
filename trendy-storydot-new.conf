# HTTPS redirect for www.storydot.kr and storydot.kr
server {
    listen 443 ssl http2;
    server_name www.storydot.kr storydot.kr;

    # SSL certificates (same as trendy.storydot.kr)
    ssl_certificate /etc/letsencrypt/live/trendy.storydot.kr/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/trendy.storydot.kr/privkey.pem;

    # Redirect to trendy.storydot.kr
    return 301 https://trendy.storydot.kr$request_uri;
}

# HTTP to HTTPS redirect for all domains
server {
    listen 80;
    server_name storydot.kr www.storydot.kr trendy.storydot.kr;
    return 301 https://trendy.storydot.kr$request_uri;
}

# Main HTTPS server for trendy.storydot.kr
server {
    listen 443 ssl http2;
    server_name trendy.storydot.kr;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    root /mnt/storage/wordpress;
    # NPL STO Platform Configuration
    # ====== XPHERE EXPLORER SECTION ======
    # Explorer assets - FIRST PRIORITY
    # Xphere Indexer API
    location ^~ /indexer-api/ {
        proxy_pass http://127.0.0.1:3010/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type";
    }

    location ^~ /explorer/assets/ {
        alias /mnt/storage/explorer/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Explorer main application - SECOND PRIORITY
    location ^~ /explorer/ {
        alias /mnt/storage/explorer/;
        try_files $uri $uri/ /explorer/index.html;
        index index.html;

        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    # Explorer root redirect
    location = /explorer {
        return 301 /explorer/;
    }

    location ^~ /nplsto/assets/ {
        alias /mnt/storage/nplsto/dist/public/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /nplsto/api/ {
        proxy_pass http://localhost:5007/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ^~ /nplsto/ {
        alias /mnt/storage/nplsto/dist/public/;
        try_files $uri $uri/ /nplsto/index.html;
        index index.html;
    }

    location = /nplsto {
        return 301 /nplsto/;
    }

    # MediGuard AI Healthcare Platform
    location ^~ /health/api/ {
        proxy_pass http://localhost:8098/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location ^~ /health/assets/ {
        alias /mnt/storage/health/dist/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /health/ {
        alias /mnt/storage/health/dist/;
        try_files $uri $uri/ /health/index.html;
        index index.html;

        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    location = /health {
        return 301 /health/;
    }






    # Stable assets
    # Stable WebSocket (Node.js WebSocket on port 5008)
    location ^~ /stable/ws {
        proxy_pass http://localhost:5008/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Stable API (Node.js backend on port 5008) - FIRST PRIORITY
    location ^~ /stable/api/ {
        proxy_pass http://localhost:5008/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location ^~ /stable/assets/ {
        alias /mnt/storage/stable/dist/public/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Stable frontend
    location ^~ /stable/ {
        alias /mnt/storage/stable/dist/public/;
        try_files $uri $uri/ /stable/index.html;

        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    # Root redirect
    location = /stable {
        return 301 /stable/;
    }


    # ====== XIMAGE NFT MARKETPLACE SECTION ======
    # Ximage API - FIRST PRIORITY (WebSocket support for future features)
    location ^~ /ximage/api/ws/ {
        proxy_pass http://localhost:5004/api/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket timeout
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Ximage API - SECOND PRIORITY
    location ^~ /ximage/api/ {
        proxy_pass http://localhost:5004/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # POST request optimization
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # Ximage assets - THIRD PRIORITY
    location ^~ /ximage/assets/ {
        alias /mnt/storage/ximage/dist/public/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
        try_files $uri =404;

        # CORS preflight
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # Ximage main application - FOURTH PRIORITY
    location ^~ /ximage/ {
        alias /mnt/storage/ximage/dist/public/;
        try_files $uri $uri/ /ximage/index.html;

        # Ensure proper content type for HTML files
        location ~* .html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    # Ximage exact root path
    location = /ximage {
        return 301 /ximage/;
    }

    # ====== XPSWAP DEX SECTION - HIGHEST PRIORITY ======

    # XPSwap WebSocket - MUST BE FIRST
    # XPSwap Launchpad (MemeToken) - HIGHEST PRIORITY
    # XPSwap Launchpad API (理곗)
    location ^~ /xpswap/launchpad/api/ {
        proxy_pass http://localhost:5006/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location ^~ /xpswap/api/ws/ {
        proxy_pass http://localhost:5101;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket  ㅼ
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # XPSwap API - SECOND PRIORITY
    location ^~ /xpswap/api/ {
        proxy_pass http://localhost:5000/xpswap/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # POST 泥 理 ㅼ
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # XPSwap assets - THIRD PRIORITY
    location ^~ /xpswap/assets/ {
        alias /mnt/storage/xpswap/dist/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
        try_files $uri =404;

        # CORS preflight
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control";
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # XPSwap main application - CRITICAL FIX - FOURTH PRIORITY
    location ^~ /xpswap/ {
        alias /mnt/storage/xpswap/dist/;
        try_files $uri $uri/ /xpswap/index.html;

        # Ensure proper content type for HTML files
        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
        }
    }

    # XPSwap exact root path - CRITICAL FIX
    location = /xpswap {
        return 301 /xpswap/;
    }


    # ====== NPL STO PLATFORM SECTION ======

    # ====== SUPERWALLET LANDING PAGE SECTION ======
    # SuperWallet Landing assets - FIRST PRIORITY
    location ^~ /superwallet-landing/assets/ {
        alias /mnt/storage/superwallet/dist/landing/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SuperWallet Landing main - SECOND PRIORITY
    location ^~ /superwallet-landing/ {
        alias /mnt/storage/superwallet/dist/landing/;
        try_files $uri $uri/ /superwallet-landing/index.html;
        index index.html;

        # HTML files no cache
        location ~* \.html$ {
            add_header Content-Type "text/html; charset=utf-8";
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }

    # SuperWallet Landing root redirect
    location = /superwallet-landing {
        return 301 /superwallet-landing/;
    }


    # SuperWallet static files
    location ^~ /superwallet/ {
        alias /mnt/storage/superwallet/;
        try_files $uri $uri/ /superwallet/index.html;
    }

    # SignChain API
    location ^~ /signchain/api/ {
        proxy_pass http://localhost:5015/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # POST 泥 理 ㅼ
        proxy_connect_timeout 30s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # SignChain static files
    location ^~ /signchain/ {
        alias /mnt/storage/signchain/dist/public/;
        try_files $uri $uri/ /signchain/index.html;

    }

    # ====== TRADING BOT AI SECTION ======
    # Trading Bot Frontend - Next.js static files
    # Trading Bot _next static files (accessed from /trading)
    location ^~ /_next/ {
        proxy_pass http://localhost:3001/trading/_next/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    # Direct /api/v1/ calls redirect to Next.js proxy
    location ^~ /api/v1/ {
        proxy_pass http://localhost:3001/trading/api/v1/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # Direct API v1 access (for client-side calls without /trading prefix)
location ^~ /trading/_next/ {
        proxy_pass http://localhost:3001/trading/_next/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # Enable buffering for better performance
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # Cache static assets
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # Trading Bot API Routes (NextAuth)
    # NextAuth routes - must come BEFORE general /trading/api/ block
    # Redirect NextAuth calls without /trading prefix
    # Redirect /api/v1/ to /trading/api/v1/


    location ^~ /trading/api/auth/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # Direct backend API calls (FastAPI) - MUST come BEFORE catch-all
    location ^~ /trading/api/v1/ {
        rewrite ^/trading/api/v1/(.*) /api/v1/$1 break;
        proxy_pass http://localhost:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
        proxy_pass_header Authorization;
        proxy_set_header Authorization $http_authorization;
    }

    # Next.js API catch-all proxies (portfolio, ai, copy-trading, etc.)
    location ^~ /trading/api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }
    location = /trading {
        proxy_pass http://localhost:3001/trading;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }



    # Trading Bot Frontend
    location ^~ /trading/ {
        proxy_pass http://localhost:3001/trading/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }


    # AI Builder House Landing Page
    location ^~ /landing {
        alias /mnt/storage/landing/;
        index index.html;
    }
    # Mainnet Landing Page

    # ==============================================
    # HELIOS WALLET CONFIGURATION
    # ==============================================
    location = /wallet {
        return 301 /wallet/;
    }

    location ^~ /wallet/ {
        alias /mnt/storage/wallet/dist/;
        index index.html;
        try_files $uri $uri/ /wallet/index.html;
    }

    location ^~ /mainnet/ {
        alias /mnt/storage/mainnet/;
        try_files $uri $uri/ /mainnet/index.html;
        index index.html;
    }

    location = /mainnet {
        return 301 /mainnet/;
    }
        # System Monitoring Dashboard
    location ^~ /service/ {
        alias /mnt/storage/monitoring-dashboard/;
        try_files $uri $uri/ /service/index.html;
        index index.html;
    }
    
    # Serve markdown files in service directory as text/plain
    location ~ ^/service/.*\.md$ {
        alias /mnt/storage/monitoring-dashboard/;
        types {
            text/plain md;
        }
        default_type text/plain;
    }

    location = /service {
        return 301 /service/;
    }

    # API Documentation
    location ^~ /api-docs/ {
        alias /mnt/storage/api-documentation/;
        try_files $uri $uri/ /api-docs/index.html;
        index index.html;
    }

    location = /api-docs {
        return 301 /api-docs/;
    }




    # ====== TELEGRAM BOT SECTION ======
    # Seoul Labs Telegram Bot
    location ^~ /telegram_bot/ {
        alias /mnt/storage/wordpress/telegram_bot/;
        index seoul_labs_telegram_bot.php;

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
            fastcgi_param SCRIPT_FILENAME $request_filename;
        }
    }

    # ====== MEMETOKEN PLATFORM SECTION ======

    # ====== SUPERWALLET DID MONITOR SECTION ======
    # SuperWallet DID Static Pages (monitor, docs)
    location ^~ /superwallet-did/ {
        alias /mnt/storage/superwallet_did/;
        index index.html monitor.html superwallet-did-api-docs.html;
        try_files $uri $uri/ =404;
    }

    location = /superwallet-did {
        return 301 /superwallet-did/;
    }


    # ====== SUPERWALLET DID API SECTION ======
    # SuperWallet DID API (Port 8090) - EXISTING PRODUCTION SERVICE
    location ^~ /superwallet-api/ {
        rewrite ^/superwallet-api/(.*) /api/$1 break;
        proxy_pass http://localhost:8090;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }



    # ====== LAW (SafeCon Legal Assistant) SECTION ======
    location ^~ /law/assets/ {
        alias /mnt/storage/law/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ^~ /law/ {
        alias /mnt/storage/law/dist/;
        try_files $uri $uri/ /law/index.html;
        index index.html;
    }

    location = /law {
        return 301 /law/;
    }

    # ====== DID-BAAS SECTION ======
    # ====== REALCARE REAL ESTATE PLATFORM SECTION ======
    # RealCare assets - FIRST PRIORITY
    location ^~ /real/assets/ {
        alias /mnt/storage/real/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # RealCare Frontend SPA - SECOND PRIORITY
    location ^~ /real/ {
        alias /mnt/storage/real/dist/;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # Root path redirect
    location = /real {
        return 301 /real/;
    }
# DID-BaaS Swagger UI
    location ^~ /did-baas/swagger-ui/ {
        proxy_pass http://localhost:8091/swagger-ui/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /did-baas/swagger-ui.html {
        return 301 /did-baas/swagger-ui/index.html;
    }

    location ^~ /did-baas/api-docs {
        proxy_pass http://localhost:8091/api-docs;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # DID-BaaS Backend API - HIGHEST PRIORITY
    location ^~ /did-baas/api/ {
        rewrite ^/did-baas/api/(.*) /api/$1 break;
        proxy_pass http://localhost:8091;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers
        add_header Access-Control-Allow-Origin "https://trendy.storydot.kr" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key" always;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # DID-BaaS Static Assets - SECOND PRIORITY
    location ^~ /did-baas/assets/ {
        alias /mnt/storage/did_baas/baas-dashboard/dist/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # DID-BaaS Frontend SPA - THIRD PRIORITY
    location ^~ /did-baas/ {
        alias /mnt/storage/did_baas/baas-dashboard/dist/;
        try_files $uri $uri/ /did-baas/index.html;
        index index.html;
    }

    # Root path redirect
    location = /did-baas {
        return 301 /did-baas/;
    }
    # MemeToken API (곗 1)

    # WordPress - LAST PRIORITY - WILL NOT INTERFERE WITH XPSWAP
    location / {
        root /mnt/storage/wordpress;
        index index.php index.html index.htm;
        try_files $uri $uri/ /index.php?$args;
    }

    # PHP handling for WordPress
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

        # Increased buffers for WP-Admin
        fastcgi_read_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_connect_timeout 300s;
        fastcgi_buffer_size 256k;
        fastcgi_buffers 32 256k;
        fastcgi_busy_buffers_size 512k;
        fastcgi_temp_file_write_size 512k;
    }

    # WordPress uploads
    location ~* /wp-content/uploads/.*\.php$ {
        deny all;
    }

    # WordPress security
    location ~* /(wp-config\.php|xmlrpc\.php) {
        deny all;
    }

    # Static file caching - EXCLUDES ALL APP SPECIFIC PATHS
    location ~* ^(?!/xpswap/|/superwallet/|/signchain/|/stable/|/ximage/|/meme/).*\.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
        expires 30d;
        add_header Cache-Control "public";
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}
